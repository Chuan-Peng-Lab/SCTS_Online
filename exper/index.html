<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="UTF=8">
        <title>社会认知词库量表</title>
        <!-- 实用工具 -->
        <script src='../assets/js/jquery-3.6.0.min.js'></script>
        <!-- 核心引用 -->
        <link href="../assets/jspsych/css/jspsych.css" rel="stylesheet" type="text/css">
        <script src="jspsych.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-survey-multi-choice.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-fullscreen.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-instructions.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-survey-likert.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-survey-html-form.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-html-button-response.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-call-function.js"></script>
        <!-- 本实验的js函数 -->
        <script src="index.js"></script>
        <script src="word.js"></script>
    </head>
    <body style="text-align: center; background-color: grey; color: white;"></body>
    <script>
        // 实验参数
        let exper_number = "S01";
        let word_block_num = 150; // 单个block的单词数量
        let word_first_day = 1000; // 第一天的单词数量
        let delay = 1500; // 全部选择后 跳转延迟时间

        // 以下非实验参数
        let debug = false;
        let word_tmp; // 保存 当天需要的单词数量
        let timeline = []; // 定义空的时间线
        let info = {}; // 保存被试信息
        let variable = [];

        if (jsPsych.data.getURLVariable("debug")) { 
            debug = true;
        } // 这玩意，只是为了方便调试

        if (!localStorage.getItem("WordSurplus") || parseInt(jsPsych.data.getURLVariable("day")) === 1) { 
            // 第一天的话 或者 不存在剩余word的话
            localStorage.clear();
            let p = jsPsych.randomization.shuffle(getWord());
            word_tmp = p.splice(0, word_first_day);
            localStorage.setItem("WordSurplus", JSON.stringify(p));
        } else { 
            // 第二天
            word_tmp = JSON.parse(localStorage.getItem("WordSurplus"));
        }

        variable = [];
        for (let i = 0; i < word_tmp.length; i++) { 
            variable.push({
                word: word_tmp[i],
                len: word_tmp[i].length
            })
        }
        variable = jsPsych.randomization.shuffle(variable);

// 最初部分 实验指导语
        if (!localStorage.getItem("info") || parseInt(jsPsych.data.getURLVariable("day")) === 1) { 
            // 如果找不到信息的话
            timeline.push(begin_introduction(), info_get());
        } else { 
            // 如果 被试信息存在的话，则使用先前的信息
            info = JSON.parse(localStorage.getItem("info"));
            timeline.push(begin_introduction());
        }

// 第一部分 维度评分 1
        var scale = [1,2,3,4,5,6,7,8,9];
        let proc1 = {
            type: 'survey-likert',
            questions: [
              {prompt: "<strong>能力👇</strong>", name: 'ability', labels: scale, required: true}, 
              {prompt: "<strong>道德👇</strong>", name: 'morality', labels: scale, required: true},
              {prompt: "<strong>社交能力👇</strong>", name: 'socialSkills', labels: scale, required: true},
              {prompt: "<strong>外表👇</strong>", name: 'appearance', labels: scale, required: true},
              {prompt: "<strong>社会经济地位👇</strong>", name: 'socioeconomicStatus', labels: scale, required: true}
            ],
            preamble: function() {
                return '<p style="font-size: 30px;font-weight: 700;">' + jsPsych.timelineVariable("word", true) + '</p><p>请表明你对该陈述的同意程度<br/>（1 = 非常不同意，9 = 非常同意）</p>';
            },
            scale_width: 500,
            on_load: function() { 
                    // 让 标签 左移
                    let a = document.getElementsByClassName("jspsych-survey-likert-statement");
                    for (let i = 0; i < a.length; i++){ 
                        a[i].style.textAlign = "left";
                        a[i].style.paddingTop = "0px";
                    }
                    // 隐藏 continue 按钮
                    document.getElementById("jspsych-survey-likert-next").style.visibility="hidden";

                    $("input[type=radio]").on("input", function(a){
                        // 判断是否全部选择了
                        // 如果全部选择了，则延迟1.5秒跳转
                        if($("input[name=Q0]:checked").length > 0 && 
                            $("input[name=Q1]:checked").length > 0 && 
                            $("input[name=Q2]:checked").length > 0 &&
                            $("input[name=Q3]:checked").length > 0 && 
                            $("input[name=Q4]:checked").length > 0){ 
                            setTimeout(function(){ 
                                $("#jspsych-survey-likert-next").click()
                            }, delay);
                        }
                    });
                    // 偷个懒，可以通过按键 模拟 鼠标单击
                    $("body").keydown(function(a){
                        let key = a.originalEvent.key;
                        if(parseInt(key) > 0) { 
                            $("input[name=Q0]:checked").length == 0 ? $("input[name=Q0]")[parseInt(key) - 1].click() : (
                                $("input[name=Q1]:checked").length == 0 ? $("input[name=Q1]")[parseInt(key) - 1].click() : (
                                    $("input[name=Q2]:checked").length == 0 ? $("input[name=Q2]")[parseInt(key) - 1].click() : (
                                        $("input[name=Q3]:checked").length == 0 ? $("input[name=Q3]")[parseInt(key) - 1].click() : (
                                            $("input[name=Q4]:checked").length == 0 ? $("input[name=Q4]")[parseInt(key) - 1].click() : $("body").unbind()
                                        )
                                    )
                                )
                            );
                        }
                    });
                },
                on_finish: function(data) { 
                    // 五维度评分结果呈现
                    data.ability = data.response.ability;
                    data.morality = data.response.morality;
                    data.socialSkills = data.response.socialSkills;
                    data.appearance = data.response.appearance;
                    data.socioeconomicStatus = data.response.socioeconomicStatus;
                    data.word = jsPsych.timelineVariable("word", true);
                    data.wordLen = jsPsych.timelineVariable("len", true);
                    data.subIdx = info["index"];
                    data.NumberOfExperiments = info["NumberOfExperiments"];
                    data.Name = info["Name"];
                    data.Sex = info["Sex"];
                    data.Education = info["Education"];
                    data.BirthYear = info["BirthYear"];
                    $("body").unbind();
                },
                data: {
                    save: true
                }
        };

        timeline.push(introducation_prac1());
        if(debug){ 
            timeline.push({
                timeline: [proc1],
                timeline_variables: variable.splice(0, 3)
            });
        } else { 
            timeline.push({
                timeline: [proc1],
                timeline_variables: variable.splice(0, (variable.length<word_block_num) ? variable.length : word_block_num)
            });
            while(variable.length>word_block_num) { 
                timeline.push({
                    timeline: [proc1, {
                        type: "html-keyboard-response",
                        stimulus: "休息一下吧",
                        choices: jsPsych.ALL_KEYS
                    }],
                    timeline_variables: variable.splice(0, word_block_num)
                });
            }
        }
 
// 第二部分 效度打分
        let proc2 = {
            type: 'survey-multi-choice',
            questions: [
                {prompt: jsPsych.timelineVariable("word"), options: [1,2,3,4,5,6,7,8,9], required: true, horizontal: true}
            ],
            on_load: function() { 
                // 定义头部文字样式
                document.getElementsByClassName("survey-multi-choice")[0].style = "text-align: center; font-size: 25px;";

                // 隐藏 continue 按钮
                document.getElementById("jspsych-survey-multi-choice-next").style.visibility="hidden";
                
                // 创建下方提示语
                let p = document.createElement("p");
                p.innerHTML = "请表明你对该单词的积极/消极程度评分<br/>（1 = 非常消极，9 = 非常积极）";
                p.style = "font-size: 30px; font-weight: normal;";
                document.getElementById("jspsych-content").appendChild(p);

                $("input[type=radio]").on("input", function(a){
                    // 判断是否全部选择了
                    // 如果全部选择了，则延迟1秒跳转
                    if($("input[type=radio]:checked").length > 0){ 
                        setTimeout(function(){
                            $("#jspsych-survey-multi-choice-next").click()
                        }, delay);
                    }
                });
                
                $("body").keydown(function(a){
                        let key = a.originalEvent.key;
                        if(parseInt(key) > 0) { 
                            $("input[type=radio]")[parseInt(key) - 1].click();
                        }
                    });
            },
            on_finish: function(data) { 
                // 分值的呈现
                data.validity = data.response.Q0;
                data.word = jsPsych.timelineVariable("word", true);
                data.subIdx = info["index"];
                data.NumberOfExperiments = info["NumberOfExperiments"];
                data.Name = info["Name"];
                data.Sex = info["Sex"];
                data.Education = info["Education"];
                data.BirthYear = info["BirthYear"];
            },
            data: {
                    save: true
                }
        };

        // 更新variable，防止variable为空
        timeline.push({
            type: "call-function",
            func: function() { 
                // 定义一下第二个单词block
                variable = [];
                for (let i = 0; i < word_tmp.length; i++) { 
                    variable.push({
                        word: word_tmp[i],
                        len: word_tmp[i].length
                    })
                }
                variable = jsPsych.randomization.shuffle(variable);
            }
        });

        timeline.push(introducation_prac2());
        if(debug){ 
            timeline.push({
                timeline: [proc2],
                timeline_variables: variable.splice(0, 3)
            });
        } else { 
            timeline.push({
                timeline: [proc2],
                timeline_variables: variable.splice(0, (variable.length<word_block_num) ? variable.length : word_block_num)
            });
            while(variable.length>word_block_num) { 
                timeline.push({
                    timeline: [proc2, {
                        type: "html-keyboard-response",
                        stimulus: "休息一下吧",
                        choices: jsPsych.ALL_KEYS
                    }],
                    timeline_variables: variable.splice(0, word_block_num)
                });
            };
            // 最后的时间线
            timeline.push({
                    timeline: [proc2],
                    timeline_variables: variable.splice(0, variable.length)
                });
        }

        jsPsych.init({
            timeline: timeline,
            on_finish: function() { 
                jsPsych.data.displayData();

                $("#jspsych-content")[0].innerHTML = "正在保存数据中，请稍后";

                jsPsych.data.get().filter({save: true}).filterColumns(["subIdx", "Name", "Sex", "Education", "BirthYear", "word", "wordLen", "ability", "morality", "socialSkills", "appearance", "socioeconomicStatus", "validity", "rt", "response", "trial_index", "time_elapsed", "internal_node_id"]).localSave('csv', info["index"] + "_" + info["NumberOfExperiments"] + '.csv');

                $("#jspsych-content")[0].innerHTML = "<div><p style = 'color:white; font-size = 20px'>实验结束，\
                    非常感谢您的参与！</p > \
                    <p style = 'color:white; font-size : 20px'>如果您对实验结果感兴趣，可以发邮件与我联系。</p > \
                    <p style = 'color:white; font-size : 20px'>HCP（Email: xxx@gmail.com） </p ></div>";
            }
        });

// 维度评分第二种类型，分开呈现
// // 第一部分 维度评分 2
// let proc2 = {
//             type: 'survey-multi-choice',
//             questions: [
//                 {prompt: '[单词A]用于描述【】维度', options: [1,2,3,4,5,6,7,8,9], required: true, horizontal: true}
//             ],
//             on_load: function() { 
//                 // 定义头部文字样式
//                 document.getElementsByClassName("survey-multi-choice")[0].style = "text-align: center; font-size: 25px;";

//                 // 隐藏 continue 按钮
//                 document.getElementById("jspsych-survey-multi-choice-next").style.visibility="hidden";
                
//                 // 创建下方提示语
//                 let p = document.createElement("p");
//                 p.innerHTML = "请表明你对该陈述的同意程度<br/>（1 = 非常不同意，9 = 非常同意）";
//                 p.style = "font-size: 30px; font-weight: normal;";
//                 document.getElementById("jspsych-content").appendChild(p);

//                 $("input[type=radio]").on("input", function(a){
//                     // 判断是否全部选择了
//                     // 如果全部选择了，则延迟1秒跳转
//                     if($("input[type=radio]:checked").length > 0){ 
//                         setTimeout(function(){
//                             $("#jspsych-survey-multi-choice-next").click()
//                         }, 1500);
//                     }
//                 })
//             },
//             on_finish: function(data) { 
//                 // 分值的呈现
//                 data.recognition = data.response.Q0;
//             }
//         };
//         timeline.push(proc2);
    </script>
</html>