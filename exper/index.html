<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <title>ç¤¾ä¼šè®¤çŸ¥è¯åº“é‡è¡¨</title>
        <!-- å®ç”¨å·¥å…· -->
        <script src='../assets/js/jquery-3.6.0.min.js'></script>
        <!-- æ ¸å¿ƒå¼•ç”¨ -->
        <link href="../assets/jspsych/css/jspsych.css" rel="stylesheet" type="text/css">
        <script src="jspsych.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-survey-multi-choice.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-fullscreen.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-instructions.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-survey-likert.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-survey-html-form.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-html-button-response.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="../assets/jspsych/plugins/jspsych-call-function.js"></script>
        <!-- æœ¬å®éªŒçš„jså‡½æ•° -->
        <script src="index.js"></script>
        <!-- è¿™ä¸ªwordé‡Œé¢æ”¾çš„æ˜¯å•è¯ï¼Œå…¨éƒ¨éƒ½åœ¨é‡Œé¢ -->
        <script src="word.js"></script>
    </head>
    <body style="text-align: center; background-color: grey; color: white;"></body>
    <script>
        // å®éªŒå‚æ•°
        let exper_number = "S01";
        let word_block_num = 150; // å•ä¸ªblockçš„å•è¯æ•°é‡
        let word_first_day = 1050; // ç¬¬ä¸€å¤©çš„å•è¯æ•°é‡
        let delay = 1500; // å…¨éƒ¨é€‰æ‹©å è·³è½¬å»¶è¿Ÿæ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’
        let blank = 500; // æ¯ä¸ªtrialä¹‹é—´çš„ç©ºç™½å±æ—¶é—´ å•ä½ æ¯«ç§’

        let dimension = ["èƒ½åŠ›", "é“å¾·", "ç¤¾äº¤èƒ½åŠ›", "å¤–è¡¨", "ç¤¾ä¼šç»æµåœ°ä½"]; // éœ€è¦ç»´åº¦è¯„åˆ†çš„ç»´åº¦

        // ä»¥ä¸‹éå®éªŒå‚æ•°ï¼Œæœ€å¥½ä¸æ”¹
        let debug = false;
        let word_tmp; // ä¿å­˜ å½“å¤©éœ€è¦çš„å•è¯æ•°é‡
        let timeline = []; // å®šä¹‰ç©ºçš„æ—¶é—´çº¿
        let info = {}; // ä¿å­˜è¢«è¯•ä¿¡æ¯
        let variable = []; // æ—¶é—´çº¿å˜é‡
        let timeout = 0; // è®°å½• setTimeout

        if (jsPsych.data.getURLVariable("debug")) { 
            debug = true;
            // è°ƒè¯•å‚æ•°
            word_block_num = 5;
            word_first_day = 35;
            delay = 100;
            if(jsPsych.data.getURLVariable("auto")) { 
                auto(); // è‡ªåŠ¨è¿è¡Œï¼Œæ–¹ä¾¿è°ƒè¯•
            }
        } // è¿™ç©æ„ï¼Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿è°ƒè¯•

        if (!localStorage.getItem("WordSurplus") || parseInt(jsPsych.data.getURLVariable("day")) === 1) { 
            // ç¬¬ä¸€å¤©çš„è¯ æˆ–è€… ä¸å­˜åœ¨å‰©ä½™å•è¯çš„è¯
            localStorage.removeItem("WordSurplus");
            let p = jsPsych.randomization.shuffle(getWord());
            word_tmp = p.splice(0, word_first_day);
            localStorage.setItem("WordSurplus", JSON.stringify(p));
        } else { 
            // ç¬¬äºŒå¤©
            word_tmp = JSON.parse(localStorage.getItem("WordSurplus"));
        }

// æœ€åˆéƒ¨åˆ† å®éªŒæŒ‡å¯¼è¯­
        if (!localStorage.getItem("info") || (parseInt(jsPsych.data.getURLVariable("day")) === 1 && !jsPsych.data.getURLVariable("debug"))) { 
            // å¦‚æœæ‰¾ä¸åˆ°ä¿¡æ¯çš„è¯ å¹¶ä¸” ä¸å†debugæƒ…å†µä¸‹
            timeline.push(begin_introduction(), info_get());
        } else { 
            // å¦‚æœ è¢«è¯•ä¿¡æ¯å­˜åœ¨çš„è¯ï¼Œåˆ™ä½¿ç”¨å…ˆå‰çš„ä¿¡æ¯
            info = JSON.parse(localStorage.getItem("info"));
            timeline.push(begin_introduction());
        }

// ç¬¬ä¸€éƒ¨åˆ† ç»´åº¦è¯„åˆ† 1
        let tmpWord = jsPsych.randomization.shuffle(word_tmp);
        // å¯¹å•è¯åˆ‡ç‰‡åˆ†ç»„
        while(tmpWord.length > 0) { 
            let p = tmpWord.splice(0, Math.min(word_block_num, tmpWord.length));
            for (let i = 0; i < dimension.length; i++){ 
                let a = [];
                for(let j = 0; j < p.length; j++) { 
                    a.push({
                        word: p[j],
                        dimension: dimension[i],
                        len: p[j].length,
                        wordGroup: (i + 1).toString(),
                        dimensionGroup: Math.floor(tmpWord.length / word_block_num).toString(),
                        serial: j
                    });
                }
                variable.push(a);
            }
        }
        let prac1 = {
            type: 'survey-multi-choice',
            questions: [
                {prompt: function() {
                    return jsPsych.timelineVariable("word", true) + 'ç”¨äºæè¿°' + jsPsych.timelineVariable("dimension", true) + 'ç»´åº¦';
                }, options: [1,2,3,4,5,6,7,8,9], required: true, horizontal: true}
            ],
            on_load: function() { 
                // å®šä¹‰å¤´éƒ¨æ–‡å­—æ ·å¼
                document.getElementsByClassName("survey-multi-choice")[0].style = "text-align: center; font-size: 25px;";

                // éšè— continue æŒ‰é’®
                document.getElementById("jspsych-survey-multi-choice-next").style.visibility="hidden";
                
                // åˆ›å»ºä¸‹æ–¹æç¤ºè¯­
                let p = document.createElement("p");
                p.innerHTML = "è¯·è¡¨æ˜ä½ å¯¹è¯¥é™ˆè¿°çš„åŒæ„ç¨‹åº¦<br/>ï¼ˆ1 = éå¸¸ä¸åŒæ„ï¼Œ9 = éå¸¸åŒæ„ï¼‰";
                p.style = "font-size: 30px; font-weight: normal;";
                document.getElementById("jspsych-content").appendChild(p);

                $("input[type=radio]").on("input", function(a){
                    // åˆ¤æ–­æ˜¯å¦å…¨éƒ¨é€‰æ‹©äº†
                    if($("input[type=radio]:checked").length > 0){ 
                        if(timeout != 0) { clearTimeout(timeout); timeout = 0; }
                        timeout = setTimeout(function(){
                            $("#jspsych-survey-multi-choice-next").click()
                        }, delay);
                    }
                });
                $("body").keydown(function(a){
                    let key = a.originalEvent.key;
                    if(parseInt(key) > 0) { 
                        $("input[type=radio]")[parseInt(key) - 1].click();
                    }
                });
            },
            on_finish: function(data) { 
                // åˆ†å€¼çš„å‘ˆç°
                data.word = jsPsych.timelineVariable("word", true);
                data.wordLen = jsPsych.timelineVariable("len", true);
                data.dimension = jsPsych.timelineVariable("dimension", true);
                data.wordGroup = jsPsych.timelineVariable("wordGroup", true);
                data.dimensionGroup = jsPsych.timelineVariable("dimensionGroup", true);
                data.serial = jsPsych.timelineVariable("serial", true);
                
                data.subIdx = info["index"];
                data.NumberOfExperiments = info["NumberOfExperiments"];
                data.Name = info["Name"];
                data.Sex = info["Sex"];
                data.Education = info["Education"];
                data.BirthYear = info["BirthYear"];
                data.recognition = data.response.Q0;
                // ç»™çª—å£åˆå§‹åŒ–
                $("body").unbind();
                clearTimeout(timeout);
                timeout = 0;
            },
            data: {
                save: true
            }
        };
        timeline.push(introducation_prac1(), {
            timeline: [prac1],
            timeline_variables: jsPsych.randomization.shuffle(variable.splice(Math.floor(Math.random() * variable.length), 1))[0]
        });
        while(variable.length > 0){
            timeline.push({
                type: "html-keyboard-response",
                stimulus: "ä¼‘æ¯ä¸€ä¸‹å§",
                choices: jsPsych.ALL_KEYS
            }, {
                timeline: [prac1],
                timeline_variables: jsPsych.randomization.shuffle(variable.splice(Math.floor(Math.random() * variable.length), 1))[0]
            });
        }
 
// ç¬¬äºŒéƒ¨åˆ† æ•ˆä»·æ‰“åˆ†
        // å®šä¹‰ä¸€ä¸‹ç¬¬äºŒä¸ªå•è¯block,é˜²æ­¢æ—¶é—´çº¿å˜é‡ä¸ºç©º
        variable = [];
        for (let i = 0; i < word_tmp.length; i++) { 
            variable.push({
                word: word_tmp[i],
                len: word_tmp[i].length
            });
        }
        variable = jsPsych.randomization.shuffle(variable);
        let prac2 = {
            type: 'survey-multi-choice',
            questions: [
                {prompt: jsPsych.timelineVariable("word"), options: [1,2,3,4,5,6,7,8,9], required: true, horizontal: true}
            ],
            on_load: function() { 
                // å®šä¹‰å¤´éƒ¨æ–‡å­—æ ·å¼
                document.getElementsByClassName("survey-multi-choice")[0].style = "text-align: center; font-size: 25px;";

                // éšè— continue æŒ‰é’®
                document.getElementById("jspsych-survey-multi-choice-next").style.visibility="hidden";
                
                // åˆ›å»ºä¸‹æ–¹æç¤ºè¯­
                let p = document.createElement("p");
                p.innerHTML = "è¯·è¡¨æ˜ä½ å¯¹è¯¥å•è¯çš„ç§¯æ/æ¶ˆæç¨‹åº¦è¯„åˆ†<br/>ï¼ˆ1 = éå¸¸æ¶ˆæï¼Œ9 = éå¸¸ç§¯æï¼‰";
                p.style = "font-size: 30px; font-weight: normal;";
                document.getElementById("jspsych-content").appendChild(p);

                $("input[type=radio]").on("input", function(a){
                    // åˆ¤æ–­æ˜¯å¦å…¨éƒ¨é€‰æ‹©äº†
                    // å¦‚æœå…¨éƒ¨é€‰æ‹©äº†ï¼Œåˆ™å»¶è¿Ÿ1ç§’è·³è½¬
                    if($("input[type=radio]:checked").length > 0){ 
                        if(timeout != 0) { clearTimeout(timeout); timeout = 0; }
                        timeout = setTimeout(function(){
                            $("#jspsych-survey-multi-choice-next").click()
                        }, delay);
                    }
                });
                
                $("body").keydown(function(a){
                        let key = a.originalEvent.key;
                        if(parseInt(key) > 0) { 
                            $("input[type=radio]")[parseInt(key) - 1].click();
                        }
                    });
            },
            on_finish: function(data) { 
                // åˆ†å€¼çš„å‘ˆç°
                data.validity = data.response.Q0;
                data.word = jsPsych.timelineVariable("word", true);
                data.subIdx = info["index"];
                data.NumberOfExperiments = info["NumberOfExperiments"];
                data.Name = info["Name"];
                data.Sex = info["Sex"];
                data.Education = info["Education"];
                data.BirthYear = info["BirthYear"];

                $("body").unbind();
                clearTimeout(timeout);
                timeout = 0;
            },
            data: {
                    save: true
                }
        };

        timeline.push(introducation_prac2(), {
            timeline: [prac2],
            timeline_variables: variable.splice(0, (variable.length<word_block_num) ? variable.length : word_block_num)
        });
        while(variable.length>0) { 
            timeline.push({
                type: "html-keyboard-response",
                stimulus: "ä¼‘æ¯ä¸€ä¸‹å§",
                choices: jsPsych.ALL_KEYS
            }, {
                timeline: [prac2],
                timeline_variables: variable.splice(0, Math.min(word_block_num, variable.length))
            });
        }

        jsPsych.init({
            timeline: timeline,
            default_iti: blank,
            on_finish: function() { 
                jsPsych.data.displayData();

                $("#jspsych-content")[0].innerHTML = "æ­£åœ¨ä¿å­˜æ•°æ®ä¸­ï¼Œè¯·ç¨å";

                jsPsych.data.get().filter({save: true}).filterColumns(["subIdx", "Name", "Sex", "Education", "BirthYear", "word", "wordLen", "wordGroup", "dimension", "dimensionGroup", "validity", "rt", "response", "trial_index", "time_elapsed", "internal_node_id"]).localSave('csv', info["index"] + "_" + info["NumberOfExperiments"] + '.csv');

                $("#jspsych-content")[0].innerHTML = "<div><p style = 'color:white; font-size = 20px'>å®éªŒç»“æŸï¼Œ\
                    éå¸¸æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼</p > \
                    <p style = 'color:white; font-size : 20px'>å¦‚æœæ‚¨å¯¹å®éªŒç»“æœæ„Ÿå…´è¶£ï¼Œå¯ä»¥å‘é‚®ä»¶ä¸æˆ‘è”ç³»ã€‚</p > \
                    <p style = 'color:white; font-size : 20px'>HCPï¼ˆEmail: xxx@gmail.comï¼‰ </p ></div>";
            }
        });

// var scale = [1,2,3,4,5,6,7,8,9];
//         let prac1 = {
//             type: 'survey-likert',
//             questions: [
//               {prompt: "<strong>èƒ½åŠ›ğŸ‘‡</strong>", name: 'ability', labels: scale, required: true}, 
//               {prompt: "<strong>é“å¾·ğŸ‘‡</strong>", name: 'morality', labels: scale, required: true},
//               {prompt: "<strong>ç¤¾äº¤èƒ½åŠ›ğŸ‘‡</strong>", name: 'socialSkills', labels: scale, required: true},
//               {prompt: "<strong>å¤–è¡¨ğŸ‘‡</strong>", name: 'appearance', labels: scale, required: true},
//               {prompt: "<strong>ç¤¾ä¼šç»æµåœ°ä½ğŸ‘‡</strong>", name: 'socioeconomicStatus', labels: scale, required: true}
//             ],
//             preamble: function() {
//                 return '<p style="font-size: 30px;font-weight: 700;">' + jsPsych.timelineVariable("word", true) + '</p><p>è¯·è¡¨æ˜ä½ å¯¹è¯¥é™ˆè¿°çš„åŒæ„ç¨‹åº¦<br/>ï¼ˆ1 = éå¸¸ä¸åŒæ„ï¼Œ9 = éå¸¸åŒæ„ï¼‰</p>';
//             },
//             scale_width: 500,
//             on_load: function() { 
//                     // è®© æ ‡ç­¾ å·¦ç§»
//                     let a = document.getElementsByClassName("jspsych-survey-likert-statement");
//                     for (let i = 0; i < a.length; i++){ 
//                         a[i].style.textAlign = "left";
//                         a[i].style.paddingTop = "0px";
//                     }
//                     // éšè— continue æŒ‰é’®
//                     document.getElementById("jspsych-survey-likert-next").style.visibility="hidden";

//                     $("input[type=radio]").on("input", function(a){
//                         // åˆ¤æ–­æ˜¯å¦å…¨éƒ¨é€‰æ‹©äº†
//                         // å¦‚æœå…¨éƒ¨é€‰æ‹©äº†ï¼Œåˆ™å»¶è¿Ÿ1.5ç§’è·³è½¬
//                         if($("input[name=Q0]:checked").length > 0 && 
//                             $("input[name=Q1]:checked").length > 0 && 
//                             $("input[name=Q2]:checked").length > 0 &&
//                             $("input[name=Q3]:checked").length > 0 && 
//                             $("input[name=Q4]:checked").length > 0){ 
//                             setTimeout(function(){ 
//                                 $("#jspsych-survey-likert-next").click()
//                             }, delay);
//                         }
//                     });
//                     // å·ä¸ªæ‡’ï¼Œå¯ä»¥é€šè¿‡æŒ‰é”® æ¨¡æ‹Ÿ é¼ æ ‡å•å‡»
//                     $("body").keydown(function(a){
//                         let key = a.originalEvent.key;
//                         if(parseInt(key) > 0) { 
//                             $("input[name=Q0]:checked").length == 0 ? $("input[name=Q0]")[parseInt(key) - 1].click() : (
//                                 $("input[name=Q1]:checked").length == 0 ? $("input[name=Q1]")[parseInt(key) - 1].click() : (
//                                     $("input[name=Q2]:checked").length == 0 ? $("input[name=Q2]")[parseInt(key) - 1].click() : (
//                                         $("input[name=Q3]:checked").length == 0 ? $("input[name=Q3]")[parseInt(key) - 1].click() : (
//                                             $("input[name=Q4]:checked").length == 0 ? $("input[name=Q4]")[parseInt(key) - 1].click() : $("body").unbind()
//                                         )
//                                     )
//                                 )
//                             );
//                         }
//                     });
//                 },
//                 on_finish: function(data) { 
//                     // äº”ç»´åº¦è¯„åˆ†ç»“æœå‘ˆç°
//                     data.ability = data.response.ability;
//                     data.morality = data.response.morality;
//                     data.socialSkills = data.response.socialSkills;
//                     data.appearance = data.response.appearance;
//                     data.socioeconomicStatus = data.response.socioeconomicStatus;
//                     data.word = jsPsych.timelineVariable("word", true);
//                     data.wordLen = jsPsych.timelineVariable("len", true);
//                     data.subIdx = info["index"];
//                     data.NumberOfExperiments = info["NumberOfExperiments"];
//                     data.Name = info["Name"];
//                     data.Sex = info["Sex"];
//                     data.Education = info["Education"];
//                     data.BirthYear = info["BirthYear"];
//                     $("body").unbind();
//                 },
//                 data: {
//                     save: true
//                 }
//         };
    </script>
</html>